<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>Visualing</title>
</head>
<body>

    <h2>Grouping data</h2>
    <button id="step1" onclick="drawAirlinesChart(airlines)">Step1</button>
    <svg id="out1"></svg>
    <div id="out2" style="word-wrap: break-word; white-space: pre-wrap;"></div>


    <script src=" https://d3js.org/d3.v5.min.js"></script>

    <script src='http://vega.github.io/datalib/datalib.min.js'></script>
    <!--Code section
     <script >
         let store = []
         d3.csv("routes.csv").then(d => groupby(d))

         let ky = "AirlineID"
         let kname = "AirlineName"
         let kc = "AirlineCountry"


         let byid = []
         let results = d3.select("#out1")
         let x = ""
         let gd = []


         function groupby(d) {
             store = Array.from(d)
             alert("done")
             byid = d3.nest()
                 .key(function (d) { return d.AirlineID; })
                 .key(function (d) { return d.AirlineName; })
                 .rollup(function (v) {
                     return {
                         count: v.length,
                         country:
                             v.AirlineCountry

                     };
                 })
                 .entries(store);
             byid.forEach(function (d) {
                 d.AirlineID = d.key;
                 d.Airline = d.values[0];
                 d.AirlineName = d.Airline.key
                 d.count = d.Airline.value.count
             });
             byid.flatMap(e => (e))

             document.getElementById("out2").innerHTML=JSON.stringify(byid)
             }


     </script>
-->


    <script>
        let container = d3.select("svg")

       
        function getAirlinesChartConfig() {
            let width = 350;
            let height = 400;
            let margin = {
                top: 10,
                bottom: 50,
                left: 130,
                right: 10
            }
            //The body is the are that will be occupied by the bars.
            let bodyHeight = height - margin.top - margin.bottom
            let bodyWidth = width - margin.left - margin.right

            //The container is the SVG where we will draw the chart. In our HTML is the svg tah with the id AirlinesChart

            d3.select("svg")
                .attr("width", width)
                .attr("height", height)


            
            return { width, height, margin, bodyHeight, bodyWidth, container }
        }

      

        function getAirlinesChartScales(airlines, config) {
            let { bodyWidth, bodyHeight } = config;
            alert(bodyWidth)
            let maximunCount = d3.max(airlines.map(e => e.count))
            alert(maximunCount)
            let xScale = d3.scaleLinear()
                .range([0, bodyWidth])
                .domain([0, maximunCount])


            let yScale = d3.scaleBand()
                .range([0, bodyHeight])
                .domain(airlines.map(a => a.AirlineName)) //The domain is the list of ailines names
                .padding(0.2)
           
            return { xScale, yScale }
        }

        let config = getAirlinesChartConfig()
        let scales = getAirlinesChartScales(airlines, config)


       

        function drawBarsAirlinesChart(airlines, scales, config) {
            let { margin, container } = config; // 
            let { xScale, yScale } = scales
            let body = container
                .append("g")
                .style("transform",
                    `translate(${margin.left}px,${margin.top}px)`
                )

            let bars = body
                .selectAll(".bar")
                .data(airlines)
                .enter()
                .append("rect")
                .attr("class","bar")
               
           
                
            console.log(bars)
            console.log(bars)


            //Adding a rect tag for each airline

            d3.selectAll(".bar")
                .attr("height", yScale.bandwidth())
                .attr("y", (d) => yScale(d.AirlineName))
                .attr("width", (d) => xScale(d.count))
                .attr("x", (d) => xScale())
                .attr("fill", "#2a5599")
        }

        console.log(scales.xScale(airlines.count))

        function drawAxesAirlinesChart(airlines, scales, config) {
            let { xScale, yScale } = scales
            let { container, margin, height } = config;
            let axisX = d3.axisBottom(xScale)
                .ticks(5)
           

            container.append("g")
                .style("transform",
                    `translate(${margin.left}px,${height - margin.bottom}px)`
                )
                .call(axisX)

            let axisY = d3.axisLeft(yScale)
                .ticks(5)
            container.append("g")
                .style("transform",
                    `translate(${margin.left}px,${margin.top}px)`
                )
                .call(axisY)

           
}
        drawAxesAirlinesChart(airlines, scales, config)
        drawBarsAirlinesChart(airlines, scales, config)
    </script>
</body>
</html>
